<html>

<head>
    <title>shooter</title>
    <style>
        .player {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: brown;
        }

        .currentPlayer {
            background-color: blue;
        }

        .bullet {
            position: absolute;
            width: 2px;
            height: 2px;
            background-color: black;
        }

        #score {
            position: absolute;
            right: 10px;
            top: 10px;
            background-color: #514444;
        }

        #scoreTable {
            width: 300px;
            font-family: 'Courier New', Courier, monospace;
            font-size: small;
            color: orange;
            text-align: center;
            border: 1px solid black;
        }
    </style>
</head>


<body>

    <div id="score">
        <table id="scoreTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Kills</th>
                    <th>Deaths</th>
                    <th>Score</th>
                </tr>
            </thead>
        </table>
    </div>

    <script>
        // Create WebSocket connection.
        var wsUrl = new URL('', window.location.href);

        wsUrl.protocol = wsUrl.protocol.replace('http', 'ws');
        wsUrl.port = 9206;
        const socket = new WebSocket(wsUrl.href);
        const argg = new Audio("argg.mp3");
        const scoreTable = document.getElementById("scoreTable");
        let playerId;
        function updateScore(score) {
            const tableRows = scoreTable.rows.length;
            for (let i = 1; i < tableRows; i++) {
                scoreTable.deleteRow(1);
            }
            for (let i = 0; i < score.length; i++) {
                const playerScore = score[i];
                const scoreRow = scoreTable.insertRow(i + 1);
                scoreRow.insertCell(0).innerText = playerScore.id;
                scoreRow.insertCell(1).innerText = playerScore.kills;
                scoreRow.insertCell(2).innerText = playerScore.deaths;
                scoreRow.insertCell(3).innerText = playerScore.score;
            }
        }
        function updateGameState(gameState) {
            for (const player of gameState.players) {
                let playerDiv = document.getElementById(player.id);
                if (!playerDiv) {
                    playerDiv = document.createElement("div");
                    playerDiv.id = player.id;
                    playerDiv.classList.add("player");
                    if (player.id == playerId) {
                        playerDiv.classList.add("currentPlayer");
                    }
                    document.body.append(playerDiv);
                }
                playerDiv.style.left = `${player.x}px`;
                playerDiv.style.top = `${player.y}px`;
            }
        }
        function moveBullet(bullet, message) {
            let flightEnded = false;
            if (message.flightDirection == "up") {
                message.y -= message.bulletSpeed;
                if (message.y <= message.bulletTargetY) {
                    flightEnded = true;
                }
            } else if (message.flightDirection == "down") {
                message.y += message.bulletSpeed;
                if (message.y >= message.bulletTargetY) {
                    flightEnded = true;
                }
            } else if (message.flightDirection == "left") {
                message.x -= message.bulletSpeed;
                if (message.x <= message.bulletTargetX) {
                    flightEnded = true;
                }
            } else if (message.flightDirection == "right") {
                message.x += message.bulletSpeed;
                if (message.x >= message.bulletTargetX) {
                    flightEnded = true;
                }
            }
            bullet.style.left = `${message.x}px`;
            bullet.style.top = `${message.y}px`;
            if (flightEnded == false) {
                setTimeout(() => moveBullet(bullet, message), message.frameDuration);
            } else {
                setTimeout(() => bullet.remove(), 200);
            }
        }
        function createBullet(message) {
            const bullet = document.createElement("div");
            bullet.style.left = `${message.x}px`;
            bullet.style.top = `${message.y}px`;
            bullet.classList.add("bullet");
            document.body.append(bullet);
            moveBullet(bullet, message);
        }
        // Listen for messages
        socket.addEventListener("message", (event) => {
            console.log("Message from server ", event.data);
            const message = JSON.parse(event.data);
            switch (message.type) {
                case "gameState":
                    updateGameState(message);
                    break;
                case "currentPlayerId":
                    playerId = message.playerId;
                    break;
                case "bullet":
                    createBullet(message);
                    break;
                case "hit":
                    argg.play();
                    break;
                case "score":
                    updateScore(message.score);
                    break;
                default:
                    break;
            }
        });
        function sendMoveAction(moveDirection) {
            sendAction({
                action: "move",
                moveDirection: moveDirection
            });
        }
        function sendAction(action) {
            socket.send(JSON.stringify(action));

        }
        document.onkeydown = function (ev) {
            if (ev.key == "ArrowDown" || ev.key == "s") {
                sendMoveAction("down");
            }
            if (ev.key == "ArrowUp" || ev.key == "w") {
                sendMoveAction("up");
            }
            if (ev.key == "ArrowLeft" || ev.key == "a") {
                sendMoveAction("left");
            }
            if (ev.key == "ArrowRight" || ev.key == "d") {
                sendMoveAction("right");
            }
            if (ev.code == "Space") {
                sendAction({
                    action: "shoot"
                });
            }

        }
    </script>
</body>

</html>